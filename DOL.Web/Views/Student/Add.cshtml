@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "报名登记";
}
<div class="admin-content-body">
    <form id="form" class="am-form  am-form-inline">
        <input type="hidden" name="ID" value="@(Guid.NewGuid().ToString("N"))" />
        <div class="am-tabs am-margin" data-am-tabs="">
            <ul class="am-tabs-nav am-nav am-nav-tabs" id="selectTabUl">
                <li class="am-active"><a href="#tab1">基础信息</a></li>
            </ul>
            <div class="am-tabs-bd" style="touch-action: pan-y; -webkit-user-select: none; -webkit-user-drag: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);overflow-x:hidden">
                <div class="am-tab-panel am-fade am-in am-active" id="tab1">

                    <div class="am-g am-margin-top">
                        <div class="am-u-md-12 am-text-left">
                            <label for="user-name" class="am-form-label">身份信息：</label>
                        </div>
                    </div>
                    <div class="am-g am-margin-top">
                        <div class="am-u-md-2 am-text-right">
                            学员姓名<strong class="am-text-danger am-text-sm am-text-left">*</strong>：
                        </div>
                        <div class="am-u-md-2 am-text-left">
                            <input type="text" name="Name" class="am-input-sm" maxlength="32" style="width:160px;">
                        </div>
                        <div class="am-u-md-2 am-text-right">
                            户籍地<strong class="am-text-danger am-text-sm">*</strong>：
                        </div>
                        <div class="am-u-md-5 am-text-left am-u-end">
                            <input name="ProvinceName" id="ProvinceName" class="am-input-sm" readonly />省
                            <input name="ProvinceCode" id="ProvinceCode" type="hidden">
                            <input name="CityName" id="CityName" class="am-input-sm" readonly />市
                            <input name="CityCode" id="CityCode" type="hidden">
                        </div>
                    </div>
                    <div class="am-g am-margin-top">
                        <div class="am-u-md-2 am-text-right">
                            身份证号码<strong class="am-text-danger am-text-sm am-text-left">*</strong>：
                        </div>
                        <div class="am-u-md-4 am-text-left  am-u-end">
                            <input type="text" name="IDCard" class="am-input-sm" maxlength="20" onkeyup="isCardID(this, $('[name=\'GenderCode\']'))">
                        </div>
                    </div>
                    <div class="am-g am-margin-top">
                        <div class="am-u-md-2 am-text-right">
                            手机<strong class="am-text-danger am-text-sm am-text-left">*</strong>：
                        </div>
                        <div class="am-u-md-3 am-text-left">
                            <input type="text" name="Mobile" class="am-input-sm" maxlength="11" style="width:160px;">
                        </div>
                        <div class="am-u-md-1"></div>
                        <div class="am-u-md-1 am-text-right">
                            性别<strong class="am-text-danger am-text-sm am-text-left">*</strong>：
                        </div>
                        <div class="am-u-md-2 am-text-left  am-u-end">
                            <div class="am-u-md-1 am-text-left  am-u-end">
                                <select name="GenderCode" data-am-selected="{btnWidth: '120px',btnSize: 'sm'}" style="width:120px;" disabled>
                                    <option value="-1">未知</option>
                                    <option value="1">男</option>
                                    <option value="2">女</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="am-g am-margin-top">
                        <div class="am-u-md-2 am-text-right">
                            身份证地址<strong class="am-text-danger am-text-sm am-text-left">*</strong>：
                        </div>
                        <div class="am-u-md-7 am-text-left  am-u-end">
                            <input type="text" name="Address" class="am-input-sm" maxlength="512">
                        </div>
                    </div>

                    <hr data-am-widget="divider" style="" class="am-divider am-divider-default" />


                    <div class="am-g am-margin-top">
                        <div class="am-u-md-12 am-text-left">
                            <label for="user-name" class="am-form-label">培训计划：</label>
                        </div>
                    </div>

                    <div class="am-g am-margin-top">
                        <div class="am-u-md-2 am-text-right">
                            报名地点<strong class="am-text-danger am-text-sm am-text-left">*</strong>：
                        </div>
                        <div class="am-u-md-5 am-text-left">
                            <select name="EnteredProvinceCode" data-am-selected="{btnWidth: '120px',btnSize: 'sm'}" onchange="ShowCity(false,2)" style="width:120px;"></select>省
                            <select name="EnteredCityCode" data-am-selected="{btnWidth: '120px',btnSize: 'sm'}" onchange="LoadEnteredPoint(false, this)" style="width:120px;"></select>市
                            <select name="EnteredPointID" data-am-selected="{btnWidth: '120px',btnSize: 'sm'}" onchange="LoadReference(false,this)" style="width:120px;"></select>
                        </div>
                        <div class="am-u-md-2 am-text-right">
                            推荐人<strong class="am-text-danger am-text-sm">*</strong>：
                        </div>
                        <div class="am-u-md-2 am-u-end">
                            <select name="ReferenceID" data-am-selected="{btnWidth: '120px',btnSize: 'sm'}" style="width:120px;"></select>
                        </div>
                    </div>

                    <div class="am-g am-margin-top">

                        <div class="am-u-md-2 am-text-right">
                            报名时间<strong class="am-text-danger am-text-sm">*</strong>：
                        </div>
                        <div class="am-u-md-1">
                            <input type="text" name="EnteredDate" class="am-input-sm" style="width:120px;" placeholder="请选择报名时间" readonly onfocus="WdatePicker({ dateFmt: 'yyyy-MM-dd' })" datatype="jsondate" />
                        </div>
                        <div class="am-u-md-2 am-text-right">
                            意向驾校<strong class="am-text-danger am-text-sm">*</strong>：
                        </div>
                        <div class="am-u-md-2 am-text-left">
                            <select name="WantDriverShopID" data-am-selected="{btnWidth: '120px',btnSize: 'sm'}" style="width:120px;">
                                <option value="-1">请选择</option>
                            </select>
                        </div>
                        <div class="am-u-md-2 am-text-right">
                            学习车型<strong class="am-text-danger am-text-sm">*</strong>：
                        </div>
                        <div class="am-u-md-2  am-u-end">
                            <select name="CertificateID" data-am-selected="{btnWidth: '120px',btnSize: 'sm'}" style="width:120px;">
                                <option value="-1">请选择</option>
                            </select>
                        </div>
                    </div>

                    <div class="am-g am-margin-top">
                        <div class="am-u-md-2 am-text-right">
                            制卡时间：
                        </div>
                        <div class="am-u-md-1">
                            <input type="text" name="MakeCardDate" class="am-input-sm" style="width:120px;" placeholder="请选择时间" readonly onfocus="WdatePicker({ dateFmt: 'yyyy-MM-dd' })" datatype="jsondate" />
                        </div>

                        <div class="am-u-md-2 am-text-right">
                            制卡驾校：
                        </div>
                        <div class="am-u-md-1  am-u-end">
                            <select name="MakeDriverShopID" data-am-selected="{btnWidth: '120px',btnSize: 'sm'}" style="width:120px;">
                                <option value="-1">请选择</option>
                            </select>
                        </div>
                      
                    </div>
                    <div class="am-g am-margin-top">
                        <div class="am-u-md-2 am-text-right">
                            制卡备注：
                        </div>
                        <div class="am-u-md-7 am-text-left  am-u-end">
                            <input type="text" name="MakeCardRemark" class="am-input-sm" maxlength="128">
                        </div>
                    </div>

                    <hr data-am-widget="divider" style="" class="am-divider am-divider-default" />
                    <div class="am-g am-margin-top">
                        <div class="am-u-md-12 am-text-left">
                            <label for="user-name" class="am-form-label">费用情况：</label>
                        </div>
                    </div>

                    <div class="am-g am-margin-top">
                        <div class="am-u-md-2 am-text-right">
                            学费总价<strong class="am-text-danger am-text-sm am-text-left">*</strong>：
                        </div>
                        <div class="am-u-md-2 am-text-left  am-u-end">
                            <input type="text" name="Money" class="am-input-sm" maxlength="10">
                        </div>
                        <div class="am-u-md-2 am-text-right">
                            培训班别<strong class="am-text-danger am-text-sm">*</strong>：
                        </div>
                        <div class="am-u-md-3 am-u-end">
                            <select name="TrianID" data-am-selected="{btnWidth: '120px',btnSize: 'sm'}" style="width:120px;"></select>
                        </div>
                    </div>

                    <div class="am-g am-margin-top">
                        <div class="am-u-md-2 am-text-right">
                            缴费方式<strong class="am-text-danger am-text-sm">*</strong>：
                        </div>
                        <div class="am-u-md-2 am-u-end">
                            <select name="PayMethodID" data-am-selected="{btnWidth: '120px',btnSize: 'sm'}" style="width:120px;">
                                <option value="-1">请选择</option>
                            </select>
                        </div>
                    </div>
                    <div class="am-g am-margin-top">
                        <div class="am-u-md-2 am-text-left am-u-end">
                            缴费记录
                        </div>
                    </div>
                    <div class="am-g am-margin-top-sm">
                        <div class="am-u-lg-6">
                            <div class="am-btn-toolbar">
                                <div class="am-btn-group am-btn-group-xs">
                                    <button onclick="addPay()" type="button" class="am-btn am-btn-default"><span class="am-icon-plus"></span> 新增</button>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div id="paySearchDomain" style="display:none;">
                    </div>
                    <button class="am-btn am-btn-default" id="payBtnSearch" type="button" style="display:none;">搜索</button>
                      
                        <div class="grid_container">
                            <table id="payDataTable" class="am-table am-table-compact am-table-hover table-main">
                                <thead>
                                    <tr>
                                        <th dataname="ID" type="checkbox"></th>
                                        <th dataname="PayTime" datatype="jsondate">缴款日期</th>
                                        <th dataname="PayMoney">缴款金额</th>
                                        <th dataname="PayTypeName">支付方式</th>
                                        <th dataname="AccountName">收款账户</th>
                                        <th dataname="VoucherNO">凭证号</th>
                                        <th render="ShowThum">缩略图</th>
                                        <th type="eventlist"></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>            
                </div>
            </div>
    </form>
    <div class="am-g am-margin-top-sm am-text-center">
        <button type="button" onclick="BackUrl()" class="am-btn am-btn-primary">返回</button>
        <button type="button" onclick="AddStudent()" class="am-btn am-btn-primary am-margin-left-lg">新增</button>
        <button type="button" onclick="ClearInfo()" class="am-btn am-btn-primary am-margin-left-lg"  style="float:right;margin-right:100px;">清空数据</button>
    </div>
</div>
<script>
    LoadItemList(false, null, function () { });
    LoadProvince(false);

    function formInit(dataitem) {

        if (dataitem != null) {
            //$('#payForm [name=PayTime]').datetimepicker('update', RenderDate(dataitem.PayTime));
            if (dataitem.VoucherThum != null) {
                if (dataitem.VoucherThum != null) {
                    $("#imageDiv").show().find("img").attr("src", dataitem.VoucherThum);
                }

            }
        }
        $.Nuoya.action("/Student/GetSelectItemList", {}, function (json) {
            $(json.PayTypeList).each(function () {
                if (dataitem != null) {
                    $("#payForm select[name='PayTypeID']").append("<option  value='" + this.Value + "' " + (dataitem.PayTypeID == this.Value ? "selected" : "") + " >" + this.Text + "</option>");
                }
                else {
                    $("#payForm select[name='PayTypeID']").append("<option  value='" + this.Value + "'>" + this.Text + "</option>");
                }
            });
            $(json.AccountList).each(function () {
                if (dataitem != null) {
                    $("#payForm select[name='AccountID']").append("<option  value='" + this.Value + "' " + (dataitem.AccountID == this.Value ? "selected" : "") + ">" + this.Text + "</option>");
                }
                else {
                    $("#payForm select[name='AccountID']").append("<option  value='" + this.Value + "'>" + this.Text + "</option>");
                }
            });
        });

        //添加表单验证
        $.Nuoya.form("payForm").validate({
            rules: {
                PayTypeID: {
                    required: true
                },
                AccountID: {
                    required: true
                },
                VoucherNO: {
                    required: true,
                    maxlength: 32
                },
                PayMoney: {
                    required: true,
                    min: 0,
                    max: 99999999
                },
            },
            messages: {
                PayTypeID: {
                    required: "不允许为空",
                },
                AccountID: {
                    required: "不允许为空",
                },
                VoucherNO: {
                    required: "不允许为空",
                    maxlength: "最多{0}个字符"
                },
                PayMoney: {
                    required: "请输入数字",
                    max: "必须小于{0}",
                    min: "必须大于{0}"
                }
            }
        });
        UploadImg();
    }

    function UploadImg() {
        var headimgbtn = $("#imageFile").uploadFile({
            url: '/upload/uploadimage?mark=PayOrder',
            fileSuffixs: ["jpg", "png", "gif"],
            maximumFilesUpload: 1,//最大文件上传数
            onComplete: function (data) {
                if (data) {
                    $("[name='VoucherThum']").val(data);
                    $("#imageDiv").show().find("img").attr("src", data);
                }
                else {
                    $.Nuoya.alert("上传错误");
                }

            },
            onChosen: function (file, obj, fileSize, errorText) {
                if (errorText) {
                    $.Nuoya.alert(errorText);
                    return false;
                }
                //Loading("图片正在上传中...", "请稍等");
                uploadheadimg.submitUpload();
                return true;//返回false将取消当前选择的文件
            },
        });
        var uploadheadimg = headimgbtn.data("uploadFileData");
    }

    //新增
    function addPay() {

        var money = $("#form [name='Money']").val();


        $.Nuoya.ajaxDialog({
            closeViaDimmer: false,
            ajaxUrl: "/HtmlTemplates/User/Pay.html",
            title: "新增缴费记录",
            width: "1000px",
            height: "600px",
            callback: function (e) {
                formInit();//表单初始化     
                $("#tipsDiv").html("学费总价" + money + "元，当前已缴费0元");
            },
            buttons: [{
                label: "保存",
                callback: function (e) {
                    $.Nuoya.form("payForm").ajaxSubmit({
                        ajaxUrl: "/PayOrder/Add",
                        params: {
                            StudentID: $("[name='ID']").val(),
                            StudentName:$("#form [name='Name']").val()
                        },
                        callback: function (data) {
                            if (!data.ErrorDesc) {
                                e.hide();
                                grid.reload();
                            }
                            else
                                $.Nuoya.alert(data.ErrorDesc);
                        }
                    });
                }
            }]
        })
    }

    function IsAddCertificate(obj)
    {
        var value = $(obj).val();
        if (value == "1")
        {
            $("[name='OldCertificate']").attr("disabled", false);
        }
        else
            $("[name='OldCertificate']").attr("disabled", true);
    }

    var grid = $.Nuoya.grid({
        tableId: "payDataTable",
        //表格id
        search: {
            domainId: "paySearchDomain",
            subId: "payBtnSearch"
        },
        ajaxUrl: "/PayOrder/GetList?studentID=" + $("[name='ID']").val(),
        params: {
            StudentID: $("[name='ID']").val()
        },      
        //数据请求地址
        pageSize: 10,
        events: [
            {
                className: "am-text-secondary",
                icon: "icon-pencil-square-o",
                name: "编辑",
                url: "/PayOrder/Update",
                click: function (item) {
                    $.Nuoya.ajaxDialog({
                        closeViaDimmer: false,
                        ajaxUrl: "/HtmlTemplates/User/Pay.html",
                        title: "编辑缴费记录",
                        width: "1000px",
                        height: "600px",
                        callback: function (e) {
                            $.Nuoya.action("/PayOrder/Find", { id: item.ID }, function (model) {
                                //载入数据
                                $.Nuoya.form("payForm").dataLoad({
                                    data: model
                                });
                                formInit(model);//表单初始化
                            });
                        },
                        buttons: [{
                            label: "保存",
                            callback: function (e) {

                                $.Nuoya.form("payForm").ajaxSubmit({
                                    ajaxUrl: "/PayOrder/Update",
                                    params: {
                                        ID: item.ID,
                                        StudentID: $("[name='ID']").val()
                                    },
                                    callback: function (data) {
                                        if (!data.ErrorDesc) {
                                            e.hide();
                                            grid.reload();
                                        }
                                        else
                                            $.Nuoya.alert(data.ErrorDesc);
                                    }
                                });
                            }
                        }]
                    })

                    event.preventDefault();
                }
            },
            {
                className: "am-text-danger",
                icon: "icon-trash-o",
                name: "删除",
                url: "/PayOrder/Delete",
                click: function (item) {
                    $.Nuoya.confirm("确认删除？", function () {
                        $.Nuoya.deleteAction("/PayOrder/Delete", {
                            ids: item.ID
                        },
                        function () {
                            grid.reload();
                        });
                    });

                    event.preventDefault();
                }
            }
        ]
    });

    //添加表单验证
    $.Nuoya.form("form").validate({
        rules: {
            Name: {
                required: true,
                maxlength: 32
            },
            IDCard: {
                required: true,
                maxlength: 20
            },
            ProvinceCode: {
                required: true
            },
            CityCode: {
                required: true
            },
            Mobile: {
                required: true,
                maxlength: 11
            },
            Address: {
                required: true,
                maxlength: 512
            },
            GenderCode: {
                required: true
            },
            EnteredProvinceCode: {
                required: true
            },
            EnteredCityCode: {
                required: true
            },
            EnteredDate: {
                required: true
            },
            EnteredPointID: {
                required: true
            },
            ReferenceID: {
                required: true
            },
            Money: {
                required: true,
                min: 0,
                max: 99999999
            },
            TrianID: {
                required: true
            },
            MakeCardRemark: {
                maxlength: 128
            },
            Remark: {
                maxlength: 128
            }
        },
        messages: {

            Name: {
                required: "不允许为空",
                maxlength: "最多{0}个字符"
            },
            IDCard: {
                required: "不允许为空",
                maxlength: "最多{0}个字符"
            },
            ProvinceCode: {
                required: "不允许为空",
            },
            CityCode: {
                required: "不允许为空",
            },
            Mobile: {
                required: "不允许为空",
                maxlength: "最多{0}个字符"
            },
            Address: {
                required: "不允许为空",
                maxlength: "最多{0}个字符"
            },
            GenderCode: {
                required: "不允许为空",
            },
            EnteredProvinceCode: {
                required: "不允许为空",
            },
            EnteredCityCode: {
                required: "不允许为空",
            },
            EnteredDate: {
                required: "不允许为空",
            },
            EnteredPointID: {
                required: "不允许为空",
            },
            ReferenceID: {
                required: "不允许为空",
            },
            TrianID: {
                required: "不允许为空",
            },
            Money: {
                required: "请输入数字",
                max: "必须小于{0}",
                min: "必须大于{0}"
            },
            MakeCardRemark: {
                maxlength: "最多{0}个字符"
            },
            Remark: {
                maxlength: "最多{0}个字符"
            }
        }
    });


    function AddStudent()
    {

        if (!ValidStudent())
        {
            return false;
        }
        $.Nuoya.form("form").ajaxSubmit({
            ajaxUrl: "/Student/AddEntered",
            callback: function (data) {
                if (!data.ErrorDesc) {
                    $.Nuoya.alert("保存成功");
                   
                }
                else
                    $.Nuoya.alert(data.ErrorDesc);
            }
        });
    }

    function ClearInfo()
    {
        var guid = new GUID();
        $("#form Input").val("");
        $("#payDataTable tbody").html("");

        $("[name='ID']").val(guid.newGUID());
        //$(sexObj).find('option').eq(0).attr('selected', false);
        //$(sexObj).find('option').eq(1).attr('selected', false);
        //$(sexObj).find('option').eq(2).attr('selected', true);
        $('#form [name="MakeDriverShopID"],[name="WantDriverShopID"],[name="CertificateID"],[name="PayMethodID"],[name="GenderCode"]').each(function () {
            $(this).find('option').eq(0).attr('selected', true);
            $(this).find('option:not(:eq(0))').attr('selected', false);
        });

    }
</script>